@model DataSync.Web.Models.ViewModels.ProjectDetailsVm

@{
    ViewData["Title"] = "Project Verify";
    var activeTab = (ViewData["ActiveTab"] as string) ?? "Verify";

    var confidenceScore = 78;
    var confidenceTarget = 85;
    var blockers = Model.RulesFailed > 0 ? 2 : 0;
    var warnings = 5;
    var passed = 31;

    var evidenceValidationsRun = 42;
    var evidenceValidationsTotal = 42;
    var evidenceObjectsCovered = 12;
    var evidenceObjectsTotal = 12;

    var adfPipelineName = "ADF-Verify-Run";
    var spPackName = "sp_dmt_verify_pack";
}

<div class="verify-page">

    <div class="project-hero">
        <div class="hero-left">
            <div class="hero-logo" aria-hidden="true">
                @(string.IsNullOrWhiteSpace(Model.ClientName) ? "C" : Model.ClientName.Trim().Substring(0, 1).ToUpperInvariant())
            </div>

            <div class="hero-text">
                <div class="hero-topline">
                    <a class="crumb-link" asp-controller="Projects" asp-action="Index">Projects</a>
                    <span class="crumb-sep">/</span>
                    <span class="crumb-current">@Model.Name</span>
                </div>

                <div class="hero-title-row">
                    <h1 class="hero-title">@Model.Name</h1>
                    <div class="hero-badges">
                        <span class="pill pill-status">@Model.Status</span>
                        <span class="pill pill-health">@Model.Health</span>
                        <span class="pill pill-env">@Model.Environment</span>
                    </div>
                </div>

                <div class="hero-meta">
                    <span><strong>Client:</strong> @Model.ClientName</span>
                    <span class="subdot">•</span>
                    <span><strong>Source:</strong> @Model.SourcePlatform</span>
                    <span class="subdot">•</span>
                    <span><strong>Target:</strong> @Model.TargetPlatform</span>
                    <span class="subdot">•</span>
                    <span><strong>Owner:</strong> @Model.Owner</span>
                </div>
            </div>
        </div>

        <div class="hero-right">
           
            <button class="btn btn-secondary"><i data-lucide="shield-check"></i> Run Verify</button>
            <button class="btn btn-primary"><i data-lucide="badge-check"></i> Approve</button>
        </div>
    </div>

    <div class="details-tabs">
        <a class="tab-item @(activeTab=="Overview" ? "is-active" : "")"
           asp-controller="Projects" asp-action="Details" asp-route-id="@Model.Id">Overview</a>

        <a class="tab-item @(activeTab=="Fetch" ? "is-active" : "")"
           asp-controller="Projects" asp-action="Fetch" asp-route-id="@Model.Id">Extract</a>

        <a class="tab-item @(activeTab=="Verify" ? "is-active" : "")"
           asp-controller="Projects" asp-action="Verify" asp-route-id="@Model.Id">Transform</a>

        <a class="tab-item @(activeTab=="Process" ? "is-active" : "")"
           asp-controller="Projects" asp-action="Process" asp-route-id="@Model.Id">Load</a>

        <a class="tab-item @(activeTab=="Config" ? "is-active" : "")"
           asp-controller="Projects" asp-action="Config" asp-route-id="@Model.Id">Config</a>
        <div class="tabs-spacer"></div>
        <div class="view-toggle">
            <button class="vt-btn is-active" data-view="decision">Decision</button>
            <button class="vt-btn" data-view="evidence">Evidence</button>
        </div>
    </div>

    @* <div class="verify-run-context">
        <div class="run-ctx-item">
            <span class="run-ctx-label">Run ID</span>
            <span class="run-ctx-value">VFY-20241223-001</span>
        </div>
        <div class="run-ctx-item">
            <span class="run-ctx-label">Environment</span>
            <span class="pill pill-env">UAT</span>
        </div>
        <div class="run-ctx-item">
            <span class="run-ctx-label">Dataset</span>
            <span class="run-ctx-value">v2024.12.23-a8f3c9</span>
        </div>
        <div class="run-ctx-item">
            <span class="run-ctx-label">Last Run</span>
            <span class="run-ctx-value">@Model.LastRunText</span>
        </div>
        <div class="run-ctx-item">
            <span class="run-ctx-label">ADF Pipeline</span>
            <span class="run-ctx-value">@adfPipelineName / run-abc123</span>
        </div>
        <div class="run-ctx-item">
            <span class="run-ctx-label">SQL Pack</span>
            <span class="run-ctx-value">@spPackName v2.1.0</span>
        </div>
    </div> *@

    @* <div class="verify-head">
        <div>
            <h2 class="verify-title">Verify</h2>
            <div class="verify-subtitle">Migration confidence gate — trust, risk, blockers, and evidence</div>
            <div class="verify-runmeta">
                <span class="mini neutral"><strong>ADF:</strong> @adfPipelineName</span>
                <span class="mini neutral"><strong>SQL:</strong> @spPackName</span>
                <span class="mini neutral"><strong>Last run:</strong> @Model.LastRunText</span>
            </div>
        </div>
        <div class="verify-controls">
            <button class="btn btn-secondary"><i data-lucide="download"></i> Export</button>
            <button class="btn btn-secondary"><i data-lucide="sliders-horizontal"></i> Filters</button>
        </div>
    </div> *@

    <div class="details-grid">
        <section class="details-main">

            <div class="verify-view-decision">
                <div class="panel">
                    <div class="panel-head">
                        <div>
                            <div class="panel-title">Decision View</div>
                            <div class="panel-sub">Confidence, blockers, evidence coverage</div>
                        </div>
                    </div>

                    <div class="verify-metrics">
                        <div class="vcard">
                            <div class="vcard-top">
                                <div class="vcard-label">Migration Confidence</div>
                                <span class="pill @(confidenceScore >= confidenceTarget ? "pill-ok" : "pill-warn")">
                                    @(confidenceScore >= confidenceTarget ? "GO" : "CAUTION")
                                </span>
                            </div>
                            <div class="donut" style="--p:@confidenceScore">
                                <div class="donut-inner">
                                    <div class="donut-num">@confidenceScore</div>
                                    <div class="donut-cap">Score</div>
                                </div>
                            </div>
                            <div class="vcard-foot">Target <strong>@confidenceTarget+</strong></div>
                        </div>

                        <div class="vcard">
                            <div class="vcard-top">
                                <div class="vcard-label">Gate Status</div>
                                <span class="pill @(blockers > 0 ? "pill-bad" : "pill-ok")">
                                    @(blockers > 0 ? "BLOCKED" : "CLEAR")
                                </span>
                            </div>
                            <div class="vcard-split">
                                <div class="mini-kpi">
                                    <div class="mini-num">@blockers</div>
                                    <div class="mini-lbl">Blockers</div>
                                </div>
                                <div class="mini-kpi">
                                    <div class="mini-num">@warnings</div>
                                    <div class="mini-lbl">Warnings</div>
                                </div>
                                <div class="mini-kpi">
                                    <div class="mini-num">@passed</div>
                                    <div class="mini-lbl">Passed</div>
                                </div>
                            </div>
                        </div>

                        <div class="vcard">
                            <div class="vcard-top">
                                <div class="vcard-label">Evidence</div>
                                <span class="pill pill-ok">COMPLETE</span>
                            </div>
                            <div class="evidence-grid">
                                <div class="ev-tile">
                                    <div class="ev-num">@evidenceValidationsRun/@evidenceValidationsTotal</div>
                                    <div class="ev-lbl">Validations</div>
                                </div>
                                <div class="ev-tile">
                                    <div class="ev-num">@evidenceObjectsCovered/@evidenceObjectsTotal</div>
                                    <div class="ev-lbl">Objects</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">

                    @* <div class="panel-head">
                        <div>
                            <div class="panel-title">Entity Verification Progress</div>
                            <div class="panel-sub">Extract → Transform → Validate pipeline status</div>
                        </div>
                        <button class="btn btn-secondary" type="button" style="align-items:flex-end;"><i data-lucide="refresh-ccw"></i> Re-run</button>
                        <button class="btn btn-secondary" type="button" style="align-items:flex-end;"><i data-lucide="download"></i> Export</button>
                    </div> *@

                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <div class="panel-title">Entity Verification Progress</div>
                            <div class="panel-sub">Extract → Transform → Validate pipeline status</div>
                        </div>

                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-primary" type="button" style="display:flex; align-items:center; gap:6px;">
                                <i data-lucide="refresh-ccw"></i> Re-run
                            </button>
                            <button class="btn btn-secondary" type="button" style="display:flex; align-items:center; gap:6px;">
                                <i data-lucide="download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="verify-object-table">
                        <div class="verify-obj-row verify-obj-head">
                            <div>Entity</div><div>Coverage</div><div>Exceptions</div><div>Rows</div><div>Last Verified</div><div>Action</div>
                        </div>
                        <div class="verify-obj-row">
                            <div class="verify-obj-name">
                                <a asp-controller="Projects" asp-action="IssueDetails" asp-route-id="Contacts"> Contacts </a>
                            </div>
                            
                            <div class="verify-coverage">
                                <div class="verify-coverage-bar"><span style="width: 92%"></span></div>
                                <span class="verify-coverage-text">92%</span>
                            </div>
                            <div>0</div><div>45,210</div><div>Today 09:10</div><div><a style="cursor:pointer"><i data-lucide="refresh-ccw"></i></a></div>
                        </div>
                        <div class="verify-obj-row">
                            <div class="verify-obj-name">Invoices</div>
                           
                            <div class="verify-coverage">
                                <div class="verify-coverage-bar"><span style="width: 88%"></span></div>
                                <span class="verify-coverage-text">88%</span>
                            </div>
                            <div>3</div><div>61,880</div><div>Today 09:10</div><div><a style="cursor:pointer"><i data-lucide="refresh-ccw"></i></a></div>
                        </div>
                        <div class="verify-obj-row">
                            <div class="verify-obj-name">Matters</div>
                            
                            <div class="verify-coverage">
                                <div class="verify-coverage-bar verify-coverage-bar-warn"><span style="width: 38%"></span></div>
                                <span class="verify-coverage-text">38%</span>
                            </div>
                            <div>18</div><div>0</div><div>—</div><div><a style="cursor:pointer"><i data-lucide="refresh-ccw"></i></a></div>
                        </div>
                        <div class="verify-obj-row">
                            <div class="verify-obj-name">Time Entries</div>
                            
                            <div class="verify-coverage">
                                <div class="verify-coverage-bar"><span style="width: 94%"></span></div>
                                <span class="verify-coverage-text">94%</span>
                            </div>
                            <div>1</div><div>12,340</div><div>Today 09:10</div><div><a style="cursor:pointer"><i data-lucide="refresh-ccw"></i></a></div>
                        </div>
                        <div class="verify-obj-row">
                            <div class="verify-obj-name">Payments</div>
                           
                            <div class="verify-coverage">
                                <div class="verify-coverage-bar"><span style="width: 100%"></span></div>
                                <span class="verify-coverage-text">100%</span>
                            </div>
                            <div>0</div><div>4,560</div><div>Today 09:10</div><div><a style="cursor:pointer"><i data-lucide="refresh-ccw"></i></a></div>
                        </div>
                    </div>
                </div>

                
            </div>

            <div class="verify-view-evidence">
                <div class="panel">
                    <div class="panel-head">
                        <div>
                            <div class="panel-title">ADF Verification Execution</div>
                            <div class="panel-sub">Azure Data Factory pipeline run evidence</div>
                        </div>
                        <button class="btn btn-secondary" type="button"><i data-lucide="external-link"></i> View in ADF</button>
                    </div>

                    <div class="verify-adf-grid">
                        <div class="verify-adf-status">
                            <div class="verify-adf-status-icon"><i data-lucide="check-circle"></i></div>
                            <div>
                                <div class="verify-adf-status-label">Pipeline Status</div>
                                <div class="verify-adf-status-value">Succeeded</div>
                            </div>
                        </div>
                        <div class="verify-adf-detail">
                            <div class="verify-adf-kv">
                                <span class="verify-adf-k">Start Time</span>
                                <span class="verify-adf-v">Today, 09:08:14</span>
                            </div>
                            <div class="verify-adf-kv">
                                <span class="verify-adf-k">End Time</span>
                                <span class="verify-adf-v">Today, 09:10:28</span>
                            </div>
                            <div class="verify-adf-kv">
                                <span class="verify-adf-k">Duration</span>
                                <span class="verify-adf-v">2m 14s</span>
                            </div>
                            <div class="verify-adf-kv">
                                <span class="verify-adf-k">Trigger Type</span>
                                <span class="verify-adf-v">Manual</span>
                            </div>
                        </div>
                        <div class="verify-adf-activities">
                            <div class="verify-adf-activity-item">
                                <div class="verify-adf-activity-num">12</div>
                                <div class="verify-adf-activity-label">Executed</div>
                            </div>
                            <div class="verify-adf-activity-item verify-adf-activity-success">
                                <div class="verify-adf-activity-num">10</div>
                                <div class="verify-adf-activity-label">Succeeded</div>
                            </div>
                            <div class="verify-adf-activity-item verify-adf-activity-fail">
                                <div class="verify-adf-activity-num">2</div>
                                <div class="verify-adf-activity-label">Failed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-head">
                        <div>
                            <div class="panel-title">Evidence Pack & Audit Traceability</div>
                            <div class="panel-sub">Verification artifacts and audit trail inventory</div>
                        </div>
                        <button class="btn btn-primary" type="button"><i data-lucide="download"></i> Download Pack</button>
                    </div>

                    <div class="verify-evidence-table">
                        <div class="verify-evidence-row verify-evidence-head">
                            <div>Evidence Item</div><div>Type</div><div>Generated</div><div>Storage Path</div><div>Checksum</div><div>Status</div>
                        </div>
                        <div class="verify-evidence-row">
                            <div class="verify-evidence-name">
                                <i data-lucide="file-text"></i>
                                verification_summary_20241223.pdf
                            </div>
                            <div><span class="pill pill-type">PDF</span></div>
                            <div>Today, 09:10</div>
                            <div class="verify-evidence-path">/evidence/verify/2024-12-23/summary.pdf</div>
                            <div class="verify-evidence-hash">a8f3c9d2...</div>
                            <div><span class="pill pill-ok">Available</span></div>
                        </div>
                        <div class="verify-evidence-row">
                            <div class="verify-evidence-name">
                                <i data-lucide="file-spreadsheet"></i>
                                validation_results_detailed.csv
                            </div>
                            <div><span class="pill pill-type">CSV</span></div>
                            <div>Today, 09:10</div>
                            <div class="verify-evidence-path">/evidence/verify/2024-12-23/results.csv</div>
                            <div class="verify-evidence-hash">7b2e1f4a...</div>
                            <div><span class="pill pill-ok">Available</span></div>
                        </div>
                        <div class="verify-evidence-row">
                            <div class="verify-evidence-name">
                                <i data-lucide="database"></i>
                                exception_rows_full.parquet
                            </div>
                            <div><span class="pill pill-type">PARQUET</span></div>
                            <div>Today, 09:10</div>
                            <div class="verify-evidence-path">/evidence/verify/2024-12-23/exceptions.parquet</div>
                            <div class="verify-evidence-hash">3d9c7e8b...</div>
                            <div><span class="pill pill-ok">Available</span></div>
                        </div>
                        <div class="verify-evidence-row">
                            <div class="verify-evidence-name">
                                <i data-lucide="code"></i>
                                adf_pipeline_execution_log.json
                            </div>
                            <div><span class="pill pill-type">JSON</span></div>
                            <div>Today, 09:10</div>
                            <div class="verify-evidence-path">/evidence/verify/2024-12-23/adf_log.json</div>
                            <div class="verify-evidence-hash">5f1a2d6c...</div>
                            <div><span class="pill pill-ok">Available</span></div>
                        </div>
                        <div class="verify-evidence-row">
                            <div class="verify-evidence-name">
                                <i data-lucide="shield-check"></i>
                                governance_attestation.pdf
                            </div>
                            <div><span class="pill pill-type">PDF</span></div>
                            <div>Pending</div>
                            <div class="verify-evidence-path">—</div>
                            <div class="verify-evidence-hash">—</div>
                            <div><span class="pill pill-warn">Locked</span></div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- RIGHT (Side) -->
        <aside class="overview-side">

            <!-- AI Copilot (Reusable Side Panel) -->
            <div class="panel copilot">
                <div class="copilot-head">
                    <div class="copilot-title">
                        <div class="copilot-badge">
                            <i data-lucide="sparkles"></i>
                        </div>
                        <div>
                            <div class="copilot-name">AI Copilot</div>
                            <div class="copilot-sub">Project-aware assistant (assistive only)</div>
                        </div>
                    </div>
                    <div class="copilot-status">
                        <span class="online-dot"></span> Online
                    </div>
                </div>



                <div class="copilot-insights">
                    <div class="mini-head">
                        <span>AI Insights</span>
                        <span class="mini-tag">Azure AI Foundry</span>
                    </div>

                    <div class="insight high">
                        <div class="insight-ic"><i data-lucide="alert-octagon"></i></div>
                        <div class="insight-txt">
                            <div class="insight-title">83% of failures</div>
                            <div class="insight-sub">Uniqueness + Referential Integrity patterns</div>
                        </div>
                        <span class="sev high">High</span>
                    </div>

                    <div class="insight high">
                        <div class="insight-ic"><i data-lucide="link-2"></i></div>
                        <div class="insight-txt">
                            <div class="insight-title">Highest risk object</div>
                            <div class="insight-sub">Contacts → Accounts mapping violations</div>
                        </div>
                        <span class="sev high">High</span>
                    </div>

                    <div class="insight med">
                        <div class="insight-ic"><i data-lucide="scan"></i></div>
                        <div class="insight-txt">
                            <div class="insight-title">Schema drift detected</div>
                            <div class="insight-sub">Matters transform requires manual review</div>
                        </div>
                        <span class="sev med">Medium</span>
                    </div>
                </div>



                <div class="copilot-chat" id="copilotChat" aria-label="AI chat messages">
                    <div class="msg ai">
                        Based on validation, <b>Contacts</b> readiness is <b>68%</b>, driven by
                        <b>missing first/last names</b>. This blocks automation eligibility.
                        <div class="time">2 minutes ago</div>
                    </div>

                    <div class="msg user">
                        How did we fix this in past migrations?
                        <div class="time">1 minute ago</div>
                    </div>

                    <div class="msg ai">
                        For similar cases, we’ve improved readiness by:
                        <ul>
                            <li>Re-exporting using <b>Full Contact Report</b></li>
                            <li>Applying name-splitting normalization rules</li>
                            <li>Running duplicate detection before load</li>
                        </ul>
                        <div class="time">just now</div>
                    </div>
                </div>

                <div class="copilot-input">
                    <input id="copilotInput" type="text" placeholder="Ask about this project…" />
                    <button id="copilotSend" type="button" class="send-btn" title="Send">
                        <i data-lucide="send"></i>
                    </button>
                </div>

                <div class="copilot-foot" style="display:none">
                    <button class="micro-action" type="button">
                        <i data-lucide="wrench"></i> Suggest fix
                    </button>
                    <button class="micro-action" type="button">
                        <i data-lucide="search"></i> Similar cases
                    </button>
                    <button class="micro-action" type="button">
                        <i data-lucide="terminal-square"></i> Generate SQL
                    </button>
                </div>
            </div>


        </aside>
    </div>
</div>

@section PageStyles {
<link rel="stylesheet" href="~/css/verify.css" />
}

@section Scripts {
<script>
    if (window.lucide) lucide.createIcons();

    (function() {
        const KEY = "dmt_verify_view";
        const buttons = document.querySelectorAll(".view-toggle .vt-btn");
        if (!buttons.length) return;

        function apply(view) {
            document.body.classList.toggle("verify-view-decision", view === "decision");
            document.body.classList.toggle("verify-view-evidence", view === "evidence");
            buttons.forEach(b => b.classList.toggle("is-active", b.dataset.view === view));
            localStorage.setItem(KEY, view);
        }

        const saved = localStorage.getItem(KEY);
        apply(saved === "evidence" ? "evidence" : "decision");

        buttons.forEach(btn => btn.addEventListener("click", () => apply(btn.dataset.view)));
    })();
</script>
}