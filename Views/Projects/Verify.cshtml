@model DataSync.Web.Models.ViewModels.ProjectDetailsVm
@{
    ViewData["Title"] = "Project Verify";
    var activeTab = (ViewData["ActiveTab"] as string) ?? "Verify";

    // --- Mock numbers (until wired to SQL/ADF) ---
    var confidenceScore = 78;               // example: computed from validation weights
    var confidenceTarget = 85;
    var blockers = Model.RulesFailed > 0 ? 2 : 0;
    var warnings = 5;
    var passed = 31;

    var evidenceValidationsRun = 42;
    var evidenceValidationsTotal = 42;
    var evidenceObjectsCovered = 12;
    var evidenceObjectsTotal = 12;

    // ADF + SQL/SP labels (UI only for now)
    var adfPipelineName = "ADF-Verify-Run";
    var spPackName = "sp_dmt_verify_pack";
}

<!-- =========================
   PROJECT HERO (Same as Details/Fetch)
========================== -->
<div class="project-hero">
    <div class="hero-left">
        <div class="hero-logo" aria-hidden="true">
            @(string.IsNullOrWhiteSpace(Model.ClientName)
                ? "C"
                : Model.ClientName.Trim().Substring(0, 1).ToUpperInvariant())
        </div>

        <div class="hero-text">
            <div class="hero-topline">
                <a class="crumb-link" asp-controller="Projects" asp-action="Index">Projects</a>
                <span class="crumb-sep">/</span>
                <span class="crumb-current">@Model.Name</span>
            </div>

            <div class="hero-title-row">
                <h1 class="hero-title">@Model.Name</h1>

                <div class="hero-badges">
                    <span class="pill pill-status">@Model.Status</span>
                    <span class="pill pill-health">@Model.Health</span>
                    <span class="pill pill-env">@Model.Environment</span>
                </div>
            </div>

            <div class="hero-meta">
                <span><strong>Client:</strong> @Model.ClientName</span>
                <span class="subdot">•</span>
                <span><strong>Source:</strong> @Model.SourcePlatform</span>
                <span class="subdot">•</span>
                <span><strong>Target:</strong> @Model.TargetPlatform</span>
                <span class="subdot">•</span>
                <span><strong>Owner:</strong> @Model.Owner</span>
            </div>
        </div>
    </div>

    <div class="hero-right">
        <button class="btn btn-secondary" type="button" title="Export evidence pack">
            <i data-lucide="file-down"></i>
            Evidence Pack
        </button>

        <button class="btn btn-secondary" type="button" title="Run verification">
            <i data-lucide="shield-check"></i>
            Run Verify
        </button>

        <button class="btn btn-primary" type="button" title="Approve migration (governed)">
            <i data-lucide="badge-check"></i>
            Approve
        </button>
    </div>
</div>

<!-- =========================
   TABS BAR (Same as other tabs)
========================== -->
<div class="details-tabs">
    <a class="tab-item @(activeTab=="Overview" ? "is-active" : "")"
       asp-controller="Projects" asp-action="Details" asp-route-id="@Model.Id">Overview</a>

    <a class="tab-item @(activeTab=="Fetch" ? "is-active" : "")"
       asp-controller="Projects" asp-action="Fetch" asp-route-id="@Model.Id">Fetch</a>

    <a class="tab-item @(activeTab=="Verify" ? "is-active" : "")"
       asp-controller="Projects" asp-action="Verify" asp-route-id="@Model.Id">Verify</a>

    <a class="tab-item" href="#" onclick="return false;">Process</a>
    <a class="tab-item" href="#" onclick="return false;">Config</a>
    <a class="tab-item" href="#" onclick="return false;">Activity</a>

    <div class="tabs-spacer"></div>

    <div class="view-toggle" role="tablist" aria-label="Verify view toggle">
        <button class="vt-btn is-active" type="button" data-view="summary">Decision</button>
        <button class="vt-btn" type="button" data-view="details">Evidence</button>
    </div>

    <button class="tab-icon-btn" type="button" title="Notes">
        <i data-lucide="file-text"></i>
    </button>
    <button class="tab-icon-btn" type="button" title="More">
        <i data-lucide="more-horizontal"></i>
    </button>
</div>

<!-- =========================
   VERIFY HEADER (page section title)
========================== -->
<div class="verify-head">
    <div>
        <h2 class="verify-title">Verify</h2>
        <div class="verify-subtitle">Migration confidence gate — trust, risk, blockers, and evidence before approval</div>

        <div class="verify-runmeta">
            <span class="mini neutral"><strong>ADF:</strong> @adfPipelineName</span>
            <span class="mini neutral"><strong>SQL Pack:</strong> @spPackName</span>
            <span class="mini neutral"><strong>Last run:</strong> @Model.LastRunText</span>
            <span class="mini neutral"><strong>Next:</strong> @Model.NextRunText</span>
        </div>
    </div>

    <div class="verify-controls">
        <button class="btn btn-secondary" type="button">
            <i data-lucide="download"></i>
            Export Summary
        </button>
        <button class="btn btn-secondary" type="button">
            <i data-lucide="sliders-horizontal"></i>
            Filters
        </button>
    </div>
</div>

<div class="details-grid">
    <!-- =========================
       LEFT (Main)
    ========================== -->
    <section class="details-main">

        <!-- =========================
           DECISION VIEW (cards + charts)
        ========================== -->
        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Decision View</div>
                    <div class="panel-sub">Confidence score, blockers, risk concentration, and evidence coverage</div>
                </div>
            </div>

            <div class="verify-metrics">
                <!-- Confidence donut -->
                <div class="vcard">
                    <div class="vcard-top">
                        <div class="vcard-label">Migration Confidence</div>
                        <span class="pill @(confidenceScore >= confidenceTarget ? "pill-ok" : "pill-warn")">
                            @(confidenceScore >= confidenceTarget ? "GO" : "CAUTION")
                        </span>
                    </div>

                    <div class="donut" style="--p:@confidenceScore">
                        <div class="donut-inner">
                            <div class="donut-num">@confidenceScore</div>
                            <div class="donut-cap">Score</div>
                        </div>
                    </div>

                    <div class="vcard-foot">
                        Target: <strong>@confidenceTarget+</strong> for GO • Top driver: <strong>Referential integrity</strong>
                    </div>
                </div>

                <!-- Blockers/Warn/Passed -->
                <div class="vcard">
                    <div class="vcard-top">
                        <div class="vcard-label">Gate Status</div>
                        <span class="pill @(blockers > 0 ? "pill-bad" : "pill-ok")">
                            @(blockers > 0 ? "BLOCKED" : "CLEAR")
                        </span>
                    </div>

                    <div class="vcard-split">
                        <div class="mini-kpi">
                            <div class="mini-num">@blockers</div>
                            <div class="mini-lbl">Blockers</div>
                        </div>
                        <div class="mini-kpi">
                            <div class="mini-num">@warnings</div>
                            <div class="mini-lbl">Warnings</div>
                        </div>
                        <div class="mini-kpi">
                            <div class="mini-num">@passed</div>
                            <div class="mini-lbl">Passed</div>
                        </div>
                    </div>

                    <div class="vcard-foot muted">
                        Rule failures map to SQL validation pack + ADF verify pipeline output.
                    </div>
                </div>

                <!-- Evidence coverage -->
                <div class="vcard">
                    <div class="vcard-top">
                        <div class="vcard-label">Evidence Completeness</div>
                        <span class="pill pill-ok">COMPLETE</span>
                    </div>

                    <div class="evidence-grid">
                        <div class="ev-tile">
                            <div class="ev-num">@evidenceValidationsRun/@evidenceValidationsTotal</div>
                            <div class="ev-lbl">Validations executed</div>
                        </div>
                        <div class="ev-tile">
                            <div class="ev-num">@evidenceObjectsCovered/@evidenceObjectsTotal</div>
                            <div class="ev-lbl">Objects covered</div>
                        </div>
                        <div class="ev-tile">
                            <div class="ev-num">Yes</div>
                            <div class="ev-lbl">Baseline compare</div>
                        </div>
                        <div class="ev-tile">
                            <div class="ev-num">Ready</div>
                            <div class="ev-lbl">Evidence pack</div>
                        </div>
                    </div>

                    <div class="vcard-foot muted">
                        Evidence pack should include: run summary, exceptions, and object-level coverage.
                    </div>
                </div>

                <!-- Trend sparkline -->
                <div class="vcard">
                    <div class="vcard-top">
                        <div class="vcard-label">Verify Trend</div>
                        <span class="pill pill-neutral">LAST 7 RUNS</span>
                    </div>

                    <div class="spark-wrap">
                        <div class="spark-head">
                            <div class="spark-title">Confidence trend</div>
                            <div class="spark-metric">+3</div>
                        </div>

                        <svg class="sparkline" viewBox="0 0 300 60" preserveAspectRatio="none" aria-hidden="true">
                            <path class="bg" d="M0,42 L50,44 L100,40 L150,34 L200,30 L250,26 L300,24"></path>
                            <path d="M0,42 L50,44 L100,40 L150,34 L200,30 L250,26 L300,24"></path>
                        </svg>

                        <div class="spark-foot muted">Latest: 78 • Prior: 75 • Target: 85</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================
           RISK CONCENTRATION (bar chart)
        ========================== -->
        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Risk Concentration by Object</div>
                    <div class="panel-sub">Where the risk is clustering (business-impact view)</div>
                </div>
                <button class="btn btn-secondary" type="button" disabled>
                    View full breakdown
                </button>
            </div>

            <div class="risk-bars">
                <div class="rb-row">
                    <div class="rb-left">
                        <div class="rb-name">Contacts</div>
                        <div class="rb-meta">Duplicates + orphan relationships</div>
                    </div>
                    <div class="rb-mid">
                        <div class="rb-bar"><span style="width: 86%"></span></div>
                    </div>
                    <div class="rb-right">
                        <span class="pill pill-bad">HIGH</span>
                        <div class="rb-aff">3.1% affected</div>
                    </div>
                </div>

                <div class="rb-row">
                    <div class="rb-left">
                        <div class="rb-name">Matters</div>
                        <div class="rb-meta">Missing mandatory fields</div>
                    </div>
                    <div class="rb-mid">
                        <div class="rb-bar"><span style="width: 54%"></span></div>
                    </div>
                    <div class="rb-right">
                        <span class="pill pill-warn">MED</span>
                        <div class="rb-aff">1.4% affected</div>
                    </div>
                </div>

                <div class="rb-row">
                    <div class="rb-left">
                        <div class="rb-name">Invoices</div>
                        <div class="rb-meta">Tolerance / rounding</div>
                    </div>
                    <div class="rb-mid">
                        <div class="rb-bar"><span style="width: 18%"></span></div>
                    </div>
                    <div class="rb-right">
                        <span class="pill pill-ok">LOW</span>
                        <div class="rb-aff">0.1% affected</div>
                    </div>
                </div>
            </div>

            <div class="muted" style="font-size:12px;margin-top:8px;">
                Tip: risk weights can be computed from severity × row-impact × object criticality (stored in SQL config).
            </div>
        </div>

        <!-- =========================
           OBJECT PROGRESS (extraction→transform→validate)
        ========================== -->
        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Object Verification Progress</div>
                    <div class="panel-sub">Progress across ADF ingestion + SQL transformations + rule validation packs</div>
                </div>
                <button class="link-btn" type="button">View evidence logs</button>
            </div>

            <div class="objtable">
                <div class="objthead">
                    <div>Object</div>
                    <div>ADF Ingest</div>
                    <div>SQL Transform</div>
                    <div>Rule Validation</div>
                    <div>Status</div>
                    <div>Evidence</div>
                </div>

                <div class="objtrow">
                    <div class="objname">
                        <div class="objtitle">Contacts</div>
                        <div class="objsub">Rows: 45,210 • Last: @Model.LastRunText</div>
                    </div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><div class="pbar good"><span style="width: 98%"></span></div></div>
                    <div><div class="pbar bad"><span style="width: 72%"></span></div></div>
                    <div><span class="pill pill-bad">FAILED</span></div>
                    <div><button class="mini-btn" type="button"><i data-lucide="file-text"></i> View</button></div>
                </div>

                <div class="objtrow">
                    <div class="objname">
                        <div class="objtitle">Matters</div>
                        <div class="objsub">Rows: 12,980 • Last: @Model.LastRunText</div>
                    </div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><div class="pbar warn"><span style="width: 88%"></span></div></div>
                    <div><span class="pill pill-warn">WARNING</span></div>
                    <div><button class="mini-btn" type="button"><i data-lucide="file-text"></i> View</button></div>
                </div>

                <div class="objtrow">
                    <div class="objname">
                        <div class="objtitle">Invoices</div>
                        <div class="objsub">Rows: 8,114 • Last: @Model.LastRunText</div>
                    </div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><div class="pbar good"><span style="width: 100%"></span></div></div>
                    <div><span class="pill pill-ok">PASS</span></div>
                    <div><button class="mini-btn" type="button"><i data-lucide="file-text"></i> View</button></div>
                </div>
            </div>
        </div>

        <!-- =========================
           EXCEPTIONS (table)
        ========================== -->
        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Exceptions</div>
                    <div class="panel-sub">Prioritized issues from SQL validation packs + ADF output datasets</div>
                </div>

                <div class="ex-filters">
                    <span class="chip is-active">All</span>
                    <span class="chip">Blockers</span>
                    <span class="chip">Warnings</span>
                    <span class="chip">Passed</span>
                </div>
            </div>

            <div class="extable">
                <div class="exthead">
                    <div>Severity</div>
                    <div>Object</div>
                    <div>Issue</div>
                    <div>Count</div>
                    <div>Source</div>
                    <div>Last Seen</div>
                    <div></div>
                </div>

                <div class="extrow">
                    <div><span class="sev sev-bad">BLOCKER</span></div>
                    <div class="mono">Contacts</div>
                    <div>Orphan relationship: Contacts → Accounts (FK missing)</div>
                    <div class="mono">1,412</div>
                    <div class="mono">SQL:@spPackName</div>
                    <div class="mono">@Model.LastRunText</div>
                    <div><button class="mini-btn" type="button">View details</button></div>
                </div>

                <div class="extrow">
                    <div><span class="sev sev-bad">BLOCKER</span></div>
                    <div class="mono">Contacts</div>
                    <div>Duplicate key: Email + ClientId</div>
                    <div class="mono">882</div>
                    <div class="mono">ADF:@adfPipelineName</div>
                    <div class="mono">@Model.LastRunText</div>
                    <div><button class="mini-btn" type="button">View details</button></div>
                </div>

                <div class="extrow">
                    <div><span class="sev sev-warn">WARNING</span></div>
                    <div class="mono">Matters</div>
                    <div>Mandatory field missing: MatterType</div>
                    <div class="mono">126</div>
                    <div class="mono">SQL:@spPackName</div>
                    <div class="mono">@Model.LastRunText</div>
                    <div><button class="mini-btn" type="button">View details</button></div>
                </div>

                <div class="extrow">
                    <div><span class="sev sev-ok">PASS</span></div>
                    <div class="mono">Invoices</div>
                    <div>Row count match (source vs staging)</div>
                    <div class="mono">OK</div>
                    <div class="mono">ADF:@adfPipelineName</div>
                    <div class="mono">@Model.LastRunText</div>
                    <div><button class="mini-btn" type="button" disabled>View</button></div>
                </div>
            </div>

            <div class="muted" style="font-size:12px;margin-top:10px;">
                “View details” should open a drill-down page (later) showing sample rows, SQL query hints, and remediation actions.
            </div>
        </div>

        <!-- =========================
           COPILOT (static UI mock)
        ========================== -->
        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Verify Copilot</div>
                    <div class="panel-sub">Ask questions about failures, duplicates, referential issues, and evidence reporting</div>
                </div>
                <span class="pill pill-neutral">Azure AI Foundry</span>
            </div>

            <div class="copilot">
                <div class="copilot-left">
                    <div class="suggested">
                        <div class="suggested-title">Suggested prompts</div>
                        <button class="sug" type="button">Why is Contacts failing?</button>
                        <button class="sug" type="button">Show top duplicates (Email + ClientId)</button>
                        <button class="sug" type="button">Explain referential issues Contacts → Accounts</button>
                        <button class="sug" type="button">Generate evidence report for sign-off</button>
                    </div>
                </div>

                <div class="copilot-chat" role="region" aria-label="Copilot chat transcript">
                    <div class="msg msg-user">
                        <div class="bubble">
                            Why is this migration blocked?
                        </div>
                        <div class="msg-meta">You • just now</div>
                    </div>

                    <div class="msg msg-ai">
                        <div class="bubble">
                            The gate is blocked due to <strong>2 blockers</strong>:
                            <ul style="margin:8px 0 0 18px;">
                                <li>Orphan relationships in <strong>Contacts → Accounts</strong> (1,412 rows)</li>
                                <li>Duplicate keys in <strong>Contacts</strong> (882 rows)</li>
                            </ul>
                            Recommended next step: run the “Fix blocker” workflow, then re-run Verify.
                        </div>
                        <div class="msg-meta">Copilot • summary based on latest verify run</div>
                    </div>

                    <div class="chat-input">
                        <input class="chatbox" placeholder="Ask Copilot… e.g., “show sample orphan rows” (mock UI)" />
                        <button class="btn btn-primary" type="button">
                            <i data-lucide="send"></i>
                            Send
                        </button>
                    </div>

                    <div class="chat-foot muted">
                        Copilot explains patterns; authoritative pass/fail comes from ADF + SQL validations.
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- =========================
       RIGHT (AI + Actions + Decision/Audit)
    ========================== -->
    <aside class="details-side">

        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">AI Insights</div>
                    <div class="panel-sub">Patterns & root-cause summaries (Azure AI Foundry)</div>
                </div>
            </div>

            <ul class="ai-bullets">
                <li><strong>83%</strong> of failures cluster into <strong>2 recurring patterns</strong>.</li>
                <li>Highest risk is driven by broken relationships in <strong>Contacts → Accounts</strong>.</li>
                <li>No new failure categories since the previous run.</li>
            </ul>

            <div class="ai-callout">
                <i data-lucide="sparkles"></i>
                <div>
                    <div class="ai-callout-title">What Copilot can do next</div>
                    <div class="ai-callout-sub">Explain, summarize, and draft evidence. It won’t override validations.</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Recommended Next Actions</div>
                    <div class="panel-sub">Guided actions based on severity</div>
                </div>
            </div>

            <div class="rec-actions">
                <button class="btn btn-secondary w-100" type="button">
                    <i data-lucide="wrench"></i>
                    Fix blocker: Referential integrity
                </button>
                <button class="btn btn-secondary w-100" type="button">
                    <i data-lucide="repeat-2"></i>
                    Re-run Verify (ADF + SQL)
                </button>
                <button class="btn btn-secondary w-100" type="button">
                    <i data-lucide="file-down"></i>
                    Generate Evidence Pack
                </button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head">
                <div>
                    <div class="panel-title">Decision & Audit</div>
                    <div class="panel-sub">Governed sign-off (UI placeholders)</div>
                </div>
            </div>

            <div class="kv">
                <div class="kv-row"><div class="kv-k">Gate</div><div class="kv-v"><span class="pill @(blockers>0 ? "pill-bad" : "pill-ok")">@(blockers>0 ? "Blocked" : "Clear")</span></div></div>
                <div class="kv-row"><div class="kv-k">Approved By</div><div class="kv-v">—</div></div>
                <div class="kv-row"><div class="kv-k">Approved On</div><div class="kv-v">—</div></div>
                <div class="kv-row"><div class="kv-k">Evidence Pack</div><div class="kv-v">Not generated</div></div>
                <div class="kv-row"><div class="kv-k">Run Ref</div><div class="kv-v mono">ADF:@adfPipelineName</div></div>
            </div>

            <div class="side-actions" style="margin-top:12px;">
                <button class="btn btn-primary w-100" type="button" disabled="@(blockers>0)">
                    <i data-lucide="badge-check"></i>
                    Approve Migration
                </button>
                <button class="btn btn-secondary w-100" type="button">
                    <i data-lucide="clipboard-signature"></i>
                    Add Sign-off Note
                </button>
            </div>

            <div class="muted" style="font-size:12px;margin-top:10px;">
                Approval should write an audit record in SQL (who/when/what run) and lock the evidence snapshot.
            </div>
        </div>

    </aside>
</div>
@section PageStyles {
    <link rel="stylesheet" href="~/css/verify.css" asp-append-version="true" />
}
@section Scripts {
    <script>
        if (window.lucide) lucide.createIcons();
    </script>
}
</div>